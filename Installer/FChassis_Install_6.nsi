!include "x64.nsh"
!include "LogicLib.nsh"
!include "FileFunc.nsh"
!include "WordFunc.nsh"
!include "WinMessages.nsh"
!include "MUI2.nsh"
!include "nsDialogs.nsh"

; -----------------------------------------------------------------------------
; General Settings
; -----------------------------------------------------------------------------
!define APPNAME "FChassis"
!define VERSION "1.0.4"
!define COMPANY "Teckinsoft Neuronics Pvt. Ltd."
!define INSTALLDIR "C:\FChassis"
!define FluxSDKBin "C:\FluxSDK\Bin"
!define FluxSDKDir "C:\FluxSDK"
!define UNINSTALL_KEY "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}"
!define INSTALL_FLAG_KEY "Software\${COMPANY}\${APPNAME}"

Name "${APPNAME} ${VERSION}"
OutFile "FChassisInstaller.exe"
InstallDir "${INSTALLDIR}"
RequestExecutionLevel admin

; -----------------------------------------------------------------------------
; Variables
; -----------------------------------------------------------------------------
Var InstalledState ; 0 = not installed, 1 = same version, 2 = older version, 3 = newer version
Var ExistingInstallDir
Var ExistingVersion
Var ExtractionCompleted
Var LogFileHandle
Var LocalAppDataDir
Var AppDataDir
Var LicenseAgree ; Tracks radio button selection (1 = agree, 0 = disagree)

; -----------------------------------------------------------------------------
; Pages
; -----------------------------------------------------------------------------
; Custom license agreement page
Page custom LicensePre LicenseShow LicenseLeave

!define MUI_DIRECTORYPAGE_CUSTOMFUNCTION_PRE DirectoryPre
!insertmacro MUI_PAGE_DIRECTORY

!define MUI_INSTFILESPAGE_CUSTOMFUNCTION_SHOW InstFilesShow
!insertmacro MUI_PAGE_INSTFILES
!undef MUI_INSTFILESPAGE_CUSTOMFUNCTION_SHOW

!insertmacro MUI_UNPAGE_CONFIRM

!define MUI_INSTFILESPAGE_CUSTOMFUNCTION_SHOW un.InstFilesShow
!insertmacro MUI_UNPAGE_INSTFILES
!undef MUI_INSTFILESPAGE_CUSTOMFUNCTION_SHOW

!insertmacro MUI_LANGUAGE "English"

; -----------------------------------------------------------------------------
; Logging Macros
; -----------------------------------------------------------------------------
!macro LogMessage message
  Push $0
  ${If} $LogFileHandle != 0
    FileWrite $LogFileHandle "[$(^Name)] ${message}$\r$\n"
  ${EndIf}
  DetailPrint "LOG: ${message}"
  Pop $0
!macroend

!macro LogVar varname varvalue
  Push $0
  ${If} $LogFileHandle != 0
    FileWrite $LogFileHandle "[$(^Name)] ${varname}: ${varvalue}$\r$\n"
  ${EndIf}
  DetailPrint "LOG: ${varname}: ${varvalue}"
  Pop $0
!macroend

!macro LogError message
  Push $0
  ${If} $LogFileHandle != 0
    FileWrite $LogFileHandle "[$(^Name)] ERROR: ${message}$\r$\n"
  ${EndIf}
  DetailPrint "ERROR: ${message}"
  Pop $0
!macroend

; -----------------------------------------------------------------------------
; Helper: broadcast env change
; -----------------------------------------------------------------------------
!macro BroadcastEnvChange
  !insertmacro LogMessage "Broadcasting environment change..."
  System::Call 'USER32::SendMessageTimeout(i ${HWND_BROADCAST}, i ${WM_SETTINGCHANGE}, i 0, w "Environment", i 0, i 5000, i 0)'
  !insertmacro LogMessage "Environment change broadcast completed"
!macroend

; -----------------------------------------------------------------------------
; String manipulation functions
; -----------------------------------------------------------------------------
Function StrContains
  Exch $R0 ; substring
  Exch
  Exch $R1 ; string
  Push $R2
  Push $R3
  Push $R4
  Push $R5
  
  StrCpy $R2 0
  StrLen $R3 $R0
  StrLen $R4 $R1
  StrCpy $R5 0
  
  ${Do}
    StrCpy $R2 $R1 $R3 $R5
    ${If} $R2 == $R0
      StrCpy $R0 1
      ${ExitDo}
    ${EndIf}
    ${If} $R5 >= $R4
      StrCpy $R0 0
      ${ExitDo}
    ${EndIf}
    IntOp $R5 $R5 + 1
  ${Loop}
  
  Pop $R5
  Pop $R4
  Pop $R3
  Pop $R2
  Pop $R1
  Exch $R0
FunctionEnd

!macro StrContains result string substring
  Push "${string}"
  Push "${substring}"
  Call StrContains
  Pop ${result}
!macroend

; -----------------------------------------------------------------------------
; Helper function to add to PATH if not already present
; -----------------------------------------------------------------------------
Function AddToPathIfNotPresent
  Exch $0 ; path to add
  Push $1
  Push $2

  ReadRegStr $1 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
  !insertmacro StrContains $2 "$0" "$1"

  ${If} $2 == 0
    !insertmacro LogMessage "Adding $0 to PATH"
    EnVar::AddValue "Path" "$0"
    Pop $2 ; error code
    ${If} $2 != 0
      !insertmacro LogError "Failed to add $0 to PATH: $2"
    ${EndIf}
  ${Else}
    !insertmacro LogMessage "$0 already in PATH"
  ${EndIf}

  Pop $2
  Pop $1
  Pop $0
FunctionEnd

; -----------------------------------------------------------------------------
; Helper function to remove from PATH with logging
; -----------------------------------------------------------------------------
Function RemoveFromPath
  Exch $0 ; path to remove
  Push $1

  EnVar::DeleteValue "Path" "$0"
  Pop $1
  ${If} $1 != 0
    !insertmacro LogError "Failed to remove $0 from PATH, error code: $1"
  ${Else}
    !insertmacro LogMessage "Successfully removed $0 from PATH"
  ${EndIf}

  Pop $1
  Pop $0
FunctionEnd

Function un.RemoveFromPath
  Exch $0 ; path to remove
  Push $1

  EnVar::DeleteValue "Path" "$0"
  Pop $1
  ${If} $1 != 0
    !insertmacro LogError "Failed to remove $0 from PATH, error code: $1"
  ${Else}
    !insertmacro LogMessage "Successfully removed $0 from PATH"
  ${EndIf}

  Pop $1
  Pop $0
FunctionEnd

; -----------------------------------------------------------------------------
; Function to delete installer on abort
; -----------------------------------------------------------------------------
Function DeleteInstaller
  !insertmacro LogMessage "Deleting installer executable..."
  Sleep 1000
  ExecWait '"cmd.exe" /C ping 127.0.0.1 -n 2 > nul & del /f /q "$EXEPATH"'
  !insertmacro LogMessage "Installer deletion command executed: $EXEPATH"
FunctionEnd

; -----------------------------------------------------------------------------
; Function to handle early abortion (version conflicts)
; -----------------------------------------------------------------------------
Function .onGUIEnd
  ${If} ${Errors}
    !insertmacro LogMessage "Installation aborted with errors, deleting installer..."
    Call DeleteInstaller
  ${EndIf}
FunctionEnd

; -----------------------------------------------------------------------------
; Function called when installation fails
; -----------------------------------------------------------------------------
Function .onInstFailed
  !insertmacro LogMessage "Installation failed, deleting installer..."
  Call DeleteInstaller
FunctionEnd

; -----------------------------------------------------------------------------
; Function called when installation succeeds
; -----------------------------------------------------------------------------
Function .onInstSuccess
  Call CreateShortcuts
  
  ; Notify system about changes
  !insertmacro BroadcastEnvChange
  
  !insertmacro LogMessage "Installation completed successfully!"
FunctionEnd

; -----------------------------------------------------------------------------
; Custom License Page Functions
; -----------------------------------------------------------------------------
Var Dialog
Var Label
Var RadioAgree
Var RadioDisagree
Var LicenseText

Function LicensePre
  !insertmacro LogMessage "=== Starting LicensePre function ==="
  ; Initialize LicenseAgree to 1 (agree by default)
  StrCpy $LicenseAgree 1
FunctionEnd

Function LicenseShow
  !insertmacro LogMessage "=== Starting LicenseShow function ==="
  
  ; Create custom dialog
  nsDialogs::Create 1018
  Pop $Dialog
  ${If} $Dialog == error
    !insertmacro LogError "Failed to create license dialog"
    Abort
  ${EndIf}
  
  ; Add label
  ${NSD_CreateLabel} 0 0u 100% 20u "Please review the license agreement below:"
  Pop $Label
  
  ; Create text box for license content
  ${NSD_CreateText} 0 20u 100% 120u ""
  Pop $LicenseText
  SendMessage $LicenseText ${EM_SETREADONLY} 1 0 ; Make it read-only
  
  ; Add radio buttons
  ${NSD_CreateRadioButton} 0 150u 100% 12u "I Agree"
  Pop $RadioAgree
  ${NSD_OnClick} $RadioAgree OnRadioAgree
  
  ${NSD_CreateRadioButton} 0 165u 100% 12u "I do not agree"
  Pop $RadioDisagree
  ${NSD_OnClick} $RadioDisagree OnRadioDisagree
  
  ; Set default selection to "I Agree"
  ${NSD_Check} $RadioAgree
  
  ; Load license text from file
  IfFileExists "${FluxSDKDir}\FChassis-License-Agreement.txt" license_exists license_missing
  
license_exists:
  !insertmacro LogMessage "Loading license text from: ${FluxSDKDir}\FChassis-License-Agreement.txt"
  FileOpen $0 "${FluxSDKDir}\FChassis-License-Agreement.txt" r
  ${If} $0 == ""
    !insertmacro LogError "Failed to open license file"
    Goto show_dialog
  ${EndIf}
  
  ; Read file content
  StrCpy $1 ""
  ${Do}
    FileRead $0 $2
    ${If} ${Errors}
      ${ExitDo}
    ${EndIf}
    StrCpy $1 "$1$2"
  ${Loop}
  FileClose $0
  
  ; Set text in the text box
  SendMessage $LicenseText ${WM_SETTEXT} 0 "STR:$1"
  Goto show_dialog
  
license_missing:
  !insertmacro LogError "License file not found: ${FluxSDKDir}\FChassis-License-Agreement.txt"
  SendMessage $LicenseText ${WM_SETTEXT} 0 "STR:License agreement file not found at: ${FluxSDKDir}\FChassis-License-Agreement.txt"
  
show_dialog:
  nsDialogs::Show
FunctionEnd

Function OnRadioAgree
  Pop $0
  StrCpy $LicenseAgree 1
  !insertmacro LogMessage "User selected: I Agree"
FunctionEnd

Function OnRadioDisagree
  Pop $0
  StrCpy $LicenseAgree 0
  !insertmacro LogMessage "User selected: I do not agree"
FunctionEnd

Function LicenseLeave
  !insertmacro LogMessage "=== Starting LicenseLeave function ==="
  ${If} $LicenseAgree == 0
    !insertmacro LogMessage "User did not agree to license, aborting installation"
    MessageBox MB_OK|MB_ICONINFORMATION "You must agree to the license agreement to proceed with the installation."
    
    ; Perform uninstall if already installed
    ${If} $InstalledState != 0
      !insertmacro LogMessage "Performing uninstall due to license disagreement"
      ExecWait '"$INSTDIR\Uninstall.exe" /S _?=$INSTDIR'
    ${EndIf}
    
    Call DeleteInstaller
    Abort
  ${EndIf}
  !insertmacro LogMessage "User agreed to license, proceeding to next page"
FunctionEnd

; -----------------------------------------------------------------------------
; Version comparison function (fixed for correct result setting and logging)
; -----------------------------------------------------------------------------
Function CompareVersions
  Exch $0 ; version 1
  Exch
  Exch $1 ; version 2
  Push $2
  Push $3
  Push $4
  Push $5
  Push $6
  Push $7
  Push $8
  Push $R0 ; save v1 for logging
  Push $R1 ; save v2 for logging

  StrCpy $R0 $0
  StrCpy $R1 $1

  !insertmacro LogVar "Comparing version" $R0
  !insertmacro LogVar "With version" $R1

  ; Parse version 1
  StrCpy $8 $0
  ${WordFind} $8 "." "E+1" $2  ; major1
  ${WordFind} $8 "." "E+2" $3  ; minor1
  ${WordFind} $8 "." "E+3" $4  ; patch1

  ; Parse version 2
  StrCpy $8 $1
  ${WordFind} $8 "." "E+1" $5  ; major2
  ${WordFind} $8 "." "E+2" $6  ; minor2
  ${WordFind} $8 "." "E+3" $7  ; patch2

  ; Handle missing parts as 0
  ${If} $4 == ""
    StrCpy $4 "0"
  ${EndIf}
  ${If} $7 == ""
    StrCpy $7 "0"
  ${EndIf}

  ; Compare major
  IntCmp $2 $5 major_equal major1_greater major2_greater

major1_greater:
  !insertmacro LogMessage "Version $R0 is greater than $R1"
  StrCpy $0 "1"
  goto done
major2_greater:
  !insertmacro LogMessage "Version $R0 is less than $R1"
  StrCpy $0 "-1"
  goto done
major_equal:
  ; Compare minor
  IntCmp $3 $6 minor_equal minor1_greater minor2_greater

minor1_greater:
  !insertmacro LogMessage "Version $R0 is greater than $R1"
  StrCpy $0 "1"
  goto done
minor2_greater:
  !insertmacro LogMessage "Version $R0 is less than $R1"
  StrCpy $0 "-1"
  goto done
minor_equal:
  ; Compare patch
  IntCmp $4 $7 patch_equal patch1_greater patch2_greater

patch_equal:
  !insertmacro LogMessage "Versions are equal"
  StrCpy $0 "0"
  goto done

patch1_greater:
  !insertmacro LogMessage "Version $R0 is greater than $R1"
  StrCpy $0 "1"
  goto done

patch2_greater:
  !insertmacro LogMessage "Version $R0 is less than $R1"
  StrCpy $0 "-1"
  goto done

done:
  Pop $R1
  Pop $R0
  Pop $8
  Pop $7
  Pop $6
  Pop $5
  Pop $4
  Pop $3
  Pop $2
  Pop $1
  Exch $0
FunctionEnd

; -----------------------------------------------------------------------------
; CreateShortcuts Function
; -----------------------------------------------------------------------------
Function CreateShortcuts
  !insertmacro LogMessage "=== Creating shortcuts ==="

  ; ---------- Ensure target executable exists ----------
  IfFileExists "$INSTDIR\Bin\FChassis.exe" +2
    Goto _ExeMissing

  !insertmacro LogMessage "Target executable found: $INSTDIR\Bin\FChassis.exe"

  ; ---------- Try ALL USERS Start Menu ----------
  SetShellVarContext all
  StrCpy $R0 "all"
  StrCpy $9 "$SMPROGRAMS\${APPNAME}"
  !insertmacro LogMessage "Ensuring Start Menu folder (all users): $9"

  ; Create folder if it does not exist
  IfFileExists "$9\*.*" +3
    ClearErrors
    CreateDirectory "$9"
    IfErrors 0 +2
      Goto _TryUserContext

  !insertmacro LogVar "Start Menu directory (all users)" "$9"
  Goto _MakeSMShortcut

  ; ---------- Fallback: CURRENT USER ----------
_TryUserContext:
  !insertmacro LogMessage "Falling back to current user context for Start Menu"
  SetShellVarContext current
  StrCpy $R0 "current"
  StrCpy $9 "$SMPROGRAMS\${APPNAME}"

  IfFileExists "$9\*.*" +3
    ClearErrors
    CreateDirectory "$9"
    IfErrors 0 +2
      Goto _CreateDesktop

  !insertmacro LogVar "Start Menu directory (current user)" "$9"

  ; ---------- Create Start Menu shortcut (with existence verification) ----------
_MakeSMShortcut:
  !insertmacro LogMessage "Creating Start Menu shortcut: $9\${APPNAME}.lnk -> $INSTDIR\Bin\FChassis.exe"

  ; Remove stale link; ignore errors
  ClearErrors
  Delete "$9\${APPNAME}.lnk"
  ClearErrors

  ; Create shortcut
  CreateShortCut "$9\${APPNAME}.lnk" "$INSTDIR\Bin\FChassis.exe" "" "$INSTDIR\Bin\FChassis.exe" 0

  ; Trust-but-verify: file existence is the ground truth
  IfFileExists "$9\${APPNAME}.lnk" +3
    !insertmacro LogError "Failed to create Start Menu shortcut in $R0 context"
    Goto _CreateDesktop
  ClearErrors
  !insertmacro LogMessage "Start Menu shortcut created in $R0 context."

  ; ---------- Create Desktop shortcut (always for current user) ----------
_CreateDesktop:
  SetShellVarContext current
  !insertmacro LogVar "Desktop directory" "$DESKTOP"

  ; Remove stale desktop link; ignore errors
  ClearErrors
  Delete "$DESKTOP\${APPNAME}.lnk"
  ClearErrors

  ; Create desktop link
  CreateShortCut "$DESKTOP\${APPNAME}.lnk" "$INSTDIR\Bin\FChassis.exe" "" "$INSTDIR\Bin\FChassis.exe" 0

  ; Verify by existence; clear any stray error on success
  IfFileExists "$DESKTOP\${APPNAME}.lnk" +3
    !insertmacro LogError "Creation of Desktop link failed: $DESKTOP\${APPNAME}.lnk"
    Goto _Done
  ClearErrors
  !insertmacro LogMessage "Desktop shortcut created."

  Goto _Done

  ; ---------- Missing EXE ----------
_ExeMissing:
  !insertmacro LogError "Target executable not found: $INSTDIR\Bin\FChassis.exe"
  MessageBox MB_OK|MB_ICONEXCLAMATION "Warning: FChassis.exe not found at installation location. Shortcuts cannot be created."

  ; ---------- Wrap up ----------
_Done:
  !insertmacro LogMessage "=== Shortcut creation completed==="
FunctionEnd

; -----------------------------------------------------------------------------
; Installation detection
; -----------------------------------------------------------------------------
Function .onInit
  ; Set 64-bit registry view for initialization
  SetRegView 64
  
  ; Initialize variables
  StrCpy $InstalledState 0 ; Default to not installed
  StrCpy $ExistingInstallDir "${INSTALLDIR}"
  StrCpy $ExistingVersion ""
  StrCpy $ExtractionCompleted 0
  StrCpy $LogFileHandle 0 ; Initialize to 0 (invalid handle)
  StrCpy $LicenseAgree 1 ; Initialize license agreement to agree

  ; Get LOCALAPPDATA for log file
  ReadRegStr $LocalAppDataDir HKCU "Volatile Environment" "LOCALAPPDATA"
  ${If} $LocalAppDataDir == ""
    StrCpy $LocalAppDataDir "$TEMP" ; Fallback to TEMP directory
  ${EndIf}
  
  ; Get APPDATA for user settings
  ReadRegStr $AppDataDir HKCU "Volatile Environment" "APPDATA"
  ${If} $AppDataDir == ""
    StrCpy $AppDataDir "$LocalAppDataDir" ; Fallback to LOCALAPPDATA if APPDATA is not available
  ${EndIf}
  !insertmacro LogVar "AppDataDir" $AppDataDir
  
  ; Ensure log directory exists
  CreateDirectory "$LocalAppDataDir"
  
  ; Initialize logging with error handling
  FileOpen $LogFileHandle "$LocalAppDataDir\FChassis_Install.log" w
  ${If} $LogFileHandle == ""
    ; If file opening failed, try TEMP directory as fallback
    StrCpy $LocalAppDataDir "$TEMP"
    FileOpen $LogFileHandle "$LocalAppDataDir\FChassis_Install.log" w
    ${If} $LogFileHandle == ""
      ; If still failing, just continue without logging to file
      StrCpy $LogFileHandle 0
      DetailPrint "ERROR: Failed to open log file in both locations"
    ${Else}
      FileWrite $LogFileHandle "=== FChassis Installation Log ===$\r$\n"
      FileWrite $LogFileHandle "Started: [$(^Time)] (Fallback to TEMP)$\r$\n"
      DetailPrint "Log file opened in TEMP directory"
    ${EndIf}
  ${Else}
    FileWrite $LogFileHandle "=== FChassis Installation Log ===$\r$\n"
    FileWrite $LogFileHandle "Started: [$(^Time)]$\r$\n"
    DetailPrint "Log file opened: $LocalAppDataDir\FChassis_Install.log"
  ${EndIf}

  ; Now log the start message using our macro (handles invalid file handles)
  !insertmacro LogMessage "=== Starting .onInit function ==="
  !insertmacro LogVar "LocalAppDataDir" $LocalAppDataDir

  !insertmacro LogMessage "Checking registry for existing installation..."

  ; Check if already installed via uninstall registry
  ReadRegStr $0 HKLM "${UNINSTALL_KEY}" "UninstallString"
  IfErrors check_install_flag
  !insertmacro LogMessage "Found uninstall registry key"
  !insertmacro LogVar "UninstallString" $0
  
  ; Get existing installation directory
  ReadRegStr $ExistingInstallDir HKLM "${UNINSTALL_KEY}" "InstallLocation"
  StrCmp $ExistingInstallDir "" 0 get_version
  StrCpy $ExistingInstallDir "${INSTALLDIR}"
  !insertmacro LogVar "ExistingInstallDir" $ExistingInstallDir
  
  get_version:
  ; Get installed version
  ReadRegStr $ExistingVersion HKLM "${UNINSTALL_KEY}" "DisplayVersion"
  IfErrors check_install_flag
  !insertmacro LogVar "ExistingVersion" $ExistingVersion
  
  ; Compare versions
  Push $ExistingVersion
  Push "${VERSION}"
  Call CompareVersions
  Pop $1
  !insertmacro LogVar "Version comparison result" $1
  
  ${If} $1 == "0"
    StrCpy $InstalledState 1 ; Same version installed
    !insertmacro LogMessage "Same version already installed"
  ${ElseIf} $1 == "1"
    StrCpy $InstalledState 3 ; Newer version installed
    !insertmacro LogMessage "Newer version already installed"
  ${Else}
    StrCpy $InstalledState 2 ; Older version installed
    !insertmacro LogMessage "Older version installed"
  ${EndIf}
  
  Goto done
  
  check_install_flag:
  !insertmacro LogMessage "Checking custom install flag registry..."
  ; Check our custom install flag
  ReadRegStr $0 HKLM "${INSTALL_FLAG_KEY}" "Installed"
  StrCmp $0 "1" 0 done
  !insertmacro LogMessage "Found custom install flag"
  
  ReadRegStr $ExistingVersion HKLM "${INSTALL_FLAG_KEY}" "Version"
  ReadRegStr $ExistingInstallDir HKLM "${INSTALL_FLAG_KEY}" "InstallPath"
  !insertmacro LogVar "ExistingVersion from custom key" $ExistingVersion
  !insertmacro LogVar "ExistingInstallDir from custom key" $ExistingInstallDir
  
  ; Compare versions if we found version info
  StrCmp $ExistingVersion "" done 0
  Push $ExistingVersion
  Push "${VERSION}"
  Call CompareVersions
  Pop $1
  !insertmacro LogVar "Version comparison result (custom key)" $1
  
  ${If} $1 == "0"
    StrCpy $InstalledState 1 ; Same version installed
    !insertmacro LogMessage "Same version installed (custom key)"
  ${ElseIf} $1 == "1"
    StrCpy $InstalledState 3 ; Newer version installed
    !insertmacro LogMessage "Newer version installed (custom key)"
  ${Else}
    StrCpy $InstalledState 2 ; Older version installed
    !insertmacro LogMessage "Older version installed (custom key)"
  ${EndIf}
  
  done:
  ; Set install directory to existing installation path
  StrCpy $INSTDIR $ExistingInstallDir
  !insertmacro LogVar "Final INSTDIR set to" $INSTDIR
  !insertmacro LogVar "InstalledState" $InstalledState
  
  !insertmacro LogMessage "=== .onInit function completed ==="
FunctionEnd

Function DirectoryPre
  !insertmacro LogMessage "=== Starting DirectoryPre function ==="
  ${If} $InstalledState == 3
    !insertmacro LogMessage "Newer version detected, showing warning message"
    MessageBox MB_OK|MB_ICONEXCLAMATION "A newer version ($ExistingVersion) of ${APPNAME} is already installed.$\nCannot downgrade to version ${VERSION}.$\n$\nPlease uninstall the newer version first."
    
    ; Delete installer after showing message
    !insertmacro LogMessage "Deleting installer due to version conflict..."
    Call DeleteInstaller
    
    Abort
  ${EndIf}
  !insertmacro LogMessage "=== DirectoryPre function completed ==="
FunctionEnd

Function InstFilesShow
  !insertmacro LogMessage "=== InstFiles page shown ==="
  GetDlgItem $0 $HWNDPARENT 2   ; 2 = IDCANCEL
  EnableWindow $0 1
FunctionEnd

Function un.InstFilesShow
  !insertmacro LogMessage "=== UnInstFiles page shown ==="
  GetDlgItem $0 $HWNDPARENT 2
  EnableWindow $0 1
FunctionEnd

; -----------------------------------------------------------------------------
; Function to extract thirdParty.zip with progress feedback
; -----------------------------------------------------------------------------
Function ExtractThirdParty
  !insertmacro LogMessage "=== Starting ExtractThirdParty function ==="
  
  ; Check if extraction is already done
  IfFileExists "$INSTDIR\Bin\thirdParty\OpenCASCADE-7.7.0-vc14-64\opencascade-7.7.0\win64\vc14\bin\TKernel.dll" extraction_complete
  !insertmacro LogMessage "ThirdParty extraction needed"
  
  DetailPrint "Extracting thirdParty.zip..."
  DetailPrint "This may take several minutes (90,000+ files)..."
  !insertmacro LogMessage "Extracting thirdParty.zip (90,000+ files, may take several minutes)"
  
  ; Show progress message
  SetDetailsPrint listonly
  DetailPrint "Extracting: Please wait patiently..."
  SetDetailsPrint both
  
  ; Extract using 7z with timeout
  !insertmacro LogMessage "Starting 7z extraction process..."
  nsExec::ExecToStack '"$INSTDIR\7z.exe" x "$INSTDIR\thirdParty.zip" -o"$INSTDIR" -y'
  Pop $0 ; Exit code
  Pop $1 ; Output
  
  ${If} $0 != 0
    !insertmacro LogError "7-Zip extraction failed with code: $0"
    !insertmacro LogError "7-Zip output: $1"
    DetailPrint "7-Zip extraction failed with code: $0"
    DetailPrint "Output: $1"
    MessageBox MB_OK|MB_ICONEXCLAMATION "Failed to extract third-party components. Installation may be incomplete."
  ${Else}
    StrCpy $ExtractionCompleted 1
    !insertmacro LogMessage "Third-party components extraction completed successfully"
    DetailPrint "Third-party components extraction completed successfully."
  ${EndIf}
  
  extraction_complete:
  !insertmacro LogMessage "ThirdParty extraction already complete or completed"
  !insertmacro LogMessage "=== ExtractThirdParty function completed ==="
FunctionEnd

; -----------------------------------------------------------------------------
; Function to handle cancellation during installation
; -----------------------------------------------------------------------------
; Function .onUserAbort
  ; !insertmacro LogMessage "=== Installation abort requested ==="
  ; MessageBox MB_YESNO|MB_ICONQUESTION "Cancel installation of ${APPNAME}?" IDNO noabort

  ; !insertmacro LogMessage "User confirmed cancellation, performing cleanup"
  ; MessageBox MB_OK|MB_ICONINFORMATION "Installation canceled. Cleaning up..."
  
  ; ; Remove installed files and directories
  ; !insertmacro LogMessage "Removing installed files and directories..."
  ; RMDir /r "$INSTDIR\Bin"
  ; RMDir /r "$INSTDIR\cs"
  ; RMDir /r "$INSTDIR\de"
  ; RMDir /r "$INSTDIR\es"
  ; RMDir /r "$INSTDIR\fr"
  ; RMDir /r "$INSTDIR\hoops"
  ; RMDir /r "$INSTDIR\it"
  ; RMDir /r "$INSTDIR\ja"
  ; RMDir /r "$INSTDIR\ko"
  ; RMDir /r "$INSTDIR\pl"
  ; RMDir /r "$INSTDIR\pt-BR"
  ; RMDir /r "$INSTDIR\ru"
  ; RMDir /r "$INSTDIR\runtimes"
  ; RMDir /r "$INSTDIR\tr"
  ; RMDir /r "$INSTDIR\zh-Hans"
  ; RMDir /r "$INSTDIR\zh-Hant"
  
  ; ; Remove individual files
  ; !insertmacro LogMessage "Removing individual files..."
  ; Delete "$INSTDIR\*.dll"
  ; Delete "$INSTDIR\*.exe"
  ; Delete "$INSTDIR\*.json"
  ; Delete "$INSTDIR\*.xml"
  ; Delete "$INSTDIR\*.wad"
  ; Delete "$INSTDIR\*.pdb"
  ; Delete "$INSTDIR\*.exp"
  ; Delete "$INSTDIR\*.lib"
  ; Delete "$INSTDIR\*.ico"
  ; Delete "$INSTDIR\Uninstall.exe"
  ; Delete "$INSTDIR\thirdParty.zip"
  ; Delete "$INSTDIR\7z.exe"
  ; Delete "$INSTDIR\7z.dll"
  ; Delete "$INSTDIR\VC_redist.x64.exe"
  
  ; ; Remove user settings files from %APPDATA%\FChassis
  ; !insertmacro LogMessage "Removing user settings files..."
  ; Delete "$AppDataDir\FChassis\FChassis.User.RecentFiles.JSON"
  ; Delete "$AppDataDir\FChassis\FChassis.User.Settings.JSON"
  ; RMDir "$AppDataDir\FChassis" ; Remove directory if empty
  
  ; ; Remove shortcuts if they were created
  ; !insertmacro LogMessage "Removing shortcuts..."
  ; SetShellVarContext all
  ; Delete "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk"
  ; RMDir "$SMPROGRAMS\${APPNAME}"
  ; SetShellVarContext current
  ; Delete "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk"
  ; RMDir "$SMPROGRAMS\${APPNAME}"
  ; Delete "$DESKTOP\${APPNAME}.lnk"
  
  ; ; Remove registry entries if they were created
  ; !insertmacro LogMessage "Removing registry entries..."
  ; SetRegView 64 ; Ensure 64-bit registry view for cleanup
  ; DeleteRegKey HKLM "${UNINSTALL_KEY}"
  ; DeleteRegKey HKLM "${INSTALL_FLAG_KEY}"
  
  ; ; Remove environment variables if they were added
  ; !insertmacro LogMessage "Removing environment variables..."
  ; EnVar::SetHKLM
  ; Push "$INSTDIR\Bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\draco-1.4.1-vc14-64\bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\opencascade-7.7.0\win64\vc14\bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\ffmpeg-3.3.4-64\bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\freeimage-3.17.0-vc14-64\bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\tbb_2021.5-vc14-64\bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\freetype-2.5.5-vc14-64\bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\openvr-1.14.15-64\bin\win64"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\qt5.11.2-vc14-64\bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\rapidjson-1.1.0\bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\tcltk-86-64\bin"
  ; Call RemoveFromPath
  ; Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\vtk-6.1.0-vc14-64\bin"
  ; Call RemoveFromPath
  
  ; ; Broadcast environment change
  ; !insertmacro BroadcastEnvChange
  
  ; ; Delete installer
  ; Call DeleteInstaller
  
  ; ; Close log file
  ; FileClose $LogFileHandle

; noabort:
  ; Abort
; FunctionEnd

; Function un.onUserAbort
  ; MessageBox MB_ICONQUESTION|MB_YESNO "Cancel uninstallation of ${APPNAME}?" IDYES +2
  ; Abort
; FunctionEnd

; -----------------------------------------------------------------------------
; Installation Section
; -----------------------------------------------------------------------------
Section "Main Installation" SecMain
  !insertmacro LogMessage "=== Starting Main Installation Section ==="
  SetRegView 64 ; Ensure 64-bit registry view for installation
  
  ; Set output path to the installation directory
  SetOutPath "$INSTDIR"
  
  ; Ensure Bin directory exists
  CreateDirectory "$INSTDIR\Bin"
  !insertmacro LogMessage "Created directory: $INSTDIR\Bin"
  
  ; Check if we need to uninstall previous version
  ${If} $InstalledState == 1
    !insertmacro LogMessage "Same version already installed, proceeding with reinstallation"
  ${ElseIf} $InstalledState == 2
    !insertmacro LogMessage "Older version detected, proceeding with upgrade"
  ${EndIf}
  
  ; Copy main application files
  !insertmacro LogMessage "Copying main application files..."
  File /r "${FluxSDKDir}\*.*"
  
  ; Copy license file to installation directory
  !insertmacro LogMessage "Copying license file to installation directory..."
  IfFileExists "${FluxSDKDir}\FChassis-License-Agreement.txt" license_file_exists license_file_missing
  
license_file_exists:
  CopyFiles /SILENT "${FluxSDKDir}\FChassis-License-Agreement.txt" "$INSTDIR"
  !insertmacro LogMessage "License file copied to: $INSTDIR\FChassis-License-Agreement.txt"
  Goto license_file_done
  
license_file_missing:
  !insertmacro LogError "License file not found at source: ${FluxSDKDir}\FChassis-License-Agreement.txt"
  
license_file_done:
  
  ; Copy third-party components
  !insertmacro LogMessage "Copying third-party components..."
  File "${FluxSDKDir}\thirdParty.zip"
  File "${FluxSDKDir}\7z.exe"
  File "${FluxSDKDir}\7z.dll"
  File "${FluxSDKDir}\VC_redist.x64.exe"
  
  ; Extract third-party components
  Call ExtractThirdParty
  
  ; Copy user settings files to %APPDATA%\FChassis
  !insertmacro LogMessage "Copying user settings files to $AppDataDir\FChassis..."
  CreateDirectory "$AppDataDir\FChassis"
  IfErrors 0 +2
    !insertmacro LogError "Failed to create directory: $AppDataDir\FChassis"
  
  ; Copy FChassis.User.RecentFiles.JSON
  IfFileExists "${FluxSDKBin}\FChassis.User.RecentFiles.JSON" recent_file_exists recent_file_missing
recent_file_exists:
  !insertmacro LogMessage "Copying ${FluxSDKBin}\FChassis.User.RecentFiles.JSON to $AppDataDir\FChassis"
  CopyFiles /SILENT "${FluxSDKBin}\FChassis.User.RecentFiles.JSON" "$AppDataDir\FChassis"
  IfErrors 0 +2
    !insertmacro LogError "Failed to copy FChassis.User.RecentFiles.JSON to $AppDataDir\FChassis"
  Goto recent_file_done
recent_file_missing:
  !insertmacro LogError "FChassis.User.RecentFiles.JSON not found at ${FluxSDKBin}"
recent_file_done:

  ; Copy FChassis.User.Settings.JSON
  IfFileExists "${FluxSDKBin}\FChassis.User.Settings.JSON" settings_file_exists settings_file_missing
settings_file_exists:
  !insertmacro LogMessage "Copying ${FluxSDKBin}\FChassis.User.Settings.JSON to $AppDataDir\FChassis"
  CopyFiles /SILENT "${FluxSDKBin}\FChassis.User.Settings.JSON" "$AppDataDir\FChassis"
  IfErrors 0 +2
    !insertmacro LogError "Failed to copy FChassis.User.Settings.JSON to $AppDataDir\FChassis"
  Goto settings_file_done
settings_file_missing:
  !insertmacro LogError "FChassis.User.Settings.JSON not found at ${FluxSDKBin}"
settings_file_done:
  
  ; Install VC++ redistributable if needed
  !insertmacro LogMessage "Checking VC++ redistributable installation..."
  nsExec::ExecToStack '"$INSTDIR\VC_redist.x64.exe" /install /quiet /norestart'
  Pop $0
  !insertmacro LogVar "VC++ redistributable installation result" $0
  
  ; Add to PATH environment variable
  !insertmacro LogMessage "Adding to PATH environment variable..."
  EnVar::SetHKLM
  ; Log current PATH before modification
  ReadRegStr $0 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
  !insertmacro LogVar "System PATH before modification" $0
  
  Push "$INSTDIR\Bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\draco-1.4.1-vc14-64\bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\opencascade-7.7.0\win64\vc14\bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\ffmpeg-3.3.4-64\bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\freeimage-3.17.0-vc14-64\bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\tbb_2021.5-vc14-64\bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\freetype-2.5.5-vc14-64\bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\openvr-1.14.15-64\bin\win64"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\qt5.11.2-vc14-64\bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\rapidjson-1.1.0\bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\tcltk-86-64\bin"
  Call AddToPathIfNotPresent
  
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\vtk-6.1.0-vc14-64\bin"
  Call AddToPathIfNotPresent
  
  ; Log PATH after modification
  ReadRegStr $0 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
  !insertmacro LogVar "System PATH after modification" $0
  
  ; Broadcast environment change
  !insertmacro BroadcastEnvChange
  
  ; Write registry entries for uninstallation
  !insertmacro LogMessage "Writing registry entries..."
  WriteRegStr HKLM "${UNINSTALL_KEY}" "DisplayName" "${APPNAME}"
  WriteRegStr HKLM "${UNINSTALL_KEY}" "DisplayVersion" "${VERSION}"
  WriteRegStr HKLM "${UNINSTALL_KEY}" "Publisher" "${COMPANY}"
  WriteRegStr HKLM "${UNINSTALL_KEY}" "UninstallString" "$INSTDIR\Uninstall.exe"
  WriteRegStr HKLM "${UNINSTALL_KEY}" "InstallLocation" "$INSTDIR"
  WriteRegDWORD HKLM "${UNINSTALL_KEY}" "NoModify" 1
  WriteRegDWORD HKLM "${UNINSTALL_KEY}" "NoRepair" 1
  
  ; Write our custom install flag
  WriteRegStr HKLM "${INSTALL_FLAG_KEY}" "Installed" "1"
  WriteRegStr HKLM "${INSTALL_FLAG_KEY}" "Version" "${VERSION}"
  WriteRegStr HKLM "${INSTALL_FLAG_KEY}" "InstallPath" "$INSTDIR"
  
  ; Create uninstaller
  WriteUninstaller "$INSTDIR\Uninstall.exe"
  
  !insertmacro LogMessage "=== Main Installation Section completed ==="
SectionEnd

; -----------------------------------------------------------------------------
; Uninstaller Section
; -----------------------------------------------------------------------------
Section "Uninstall"
  !insertmacro LogMessage "=== Starting Uninstallation ==="
  SetRegView 64 ; Ensure 64-bit registry view for uninstallation
  
  ; Remove shortcuts
  !insertmacro LogMessage "Removing shortcuts..."
  ; Try 'all' context first
  SetShellVarContext all
  Delete "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk"
  !insertmacro LogMessage "Attempting to remove Start Menu directory: $SMPROGRAMS\${APPNAME}"
  RMDir "$SMPROGRAMS\${APPNAME}" ; Remove Start Menu directory if empty
  IfErrors 0 +2
    !insertmacro LogError "Failed to remove Start Menu directory: $SMPROGRAMS\${APPNAME}"
  
  ; Try 'current' context for Start Menu cleanup
  SetShellVarContext current
  Delete "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk"
  !insertmacro LogMessage "Attempting to remove user Start Menu directory: $SMPROGRAMS\${APPNAME}"
  RMDir "$SMPROGRAMS\${APPNAME}" ; Remove user Start Menu directory if empty
  IfErrors 0 +2
    !insertmacro LogError "Failed to remove user Start Menu directory: $SMPROGRAMS\${APPNAME}"
  
  ; Delete desktop shortcut
  Delete "$DESKTOP\${APPNAME}.lnk"
  
  ; Remove from PATH environment variable
  !insertmacro LogMessage "Removing from PATH environment variable..."
  EnVar::SetHKLM
  ; Log current PATH before modification
  ReadRegStr $0 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
  !insertmacro LogVar "System PATH before uninstall modification" $0
  
  Push "$INSTDIR\Bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\draco-1.4.1-vc14-64\bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\opencascade-7.7.0\win64\vc14\bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\ffmpeg-3.3.4-64\bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\freeimage-3.17.0-vc14-64\bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\tbb_2021.5-vc14-64\bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\freetype-2.5.5-vc14-64\bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\openvr-1.14.15-64\bin\win64"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\qt5.11.2-vc14-64\bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\rapidjson-1.1.0\bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\tcltk-86-64\bin"
  Call un.RemoveFromPath
  Push "$INSTDIR\thirdParty\OpenCASCADE-7.7.0-vc14-64\vtk-6.1.0-vc14-64\bin"
  Call un.RemoveFromPath
  
  ; Log PATH after modification
  ReadRegStr $0 HKLM "SYSTEM\CurrentControlSet\Control\Session Manager\Environment" "Path"
  !insertmacro LogVar "System PATH after uninstall modification" $0
  
  ; Remove user settings files from %APPDATA%\FChassis
  !insertmacro LogMessage "Removing user settings files..."
  Delete "$AppDataDir\FChassis\FChassis.User.RecentFiles.JSON"
  Delete "$AppDataDir\FChassis\FChassis.User.Settings.JSON"
  RMDir "$AppDataDir\FChassis" ; Remove directory if empty
  
  ; Broadcast environment change
  !insertmacro BroadcastEnvChange
  
  ; Remove registry entries
  !insertmacro LogMessage "Removing registry entries..."
  DeleteRegKey HKLM "${UNINSTALL_KEY}"
  DeleteRegKey HKLM "${INSTALL_FLAG_KEY}"
  
  ; Remove files and directories
  !insertmacro LogMessage "Removing files and directories..."
  RMDir /r "$INSTDIR\Bin"
  RMDir /r "$INSTDIR\cs"
  RMDir /r "$INSTDIR\de"
  RMDir /r "$INSTDIR\es"
  RMDir /r "$INSTDIR\fr"
  RMDir /r "$INSTDIR\hoops"
  RMDir /r "$INSTDIR\it"
  RMDir /r "$INSTDIR\ja"
  RMDir /r "$INSTDIR\ko"
  RMDir /r "$INSTDIR\pl"
  RMDir /r "$INSTDIR\pt-BR"
  RMDir /r "$INSTDIR\ru"
  RMDir /r "$INSTDIR\runtimes"
  RMDir /r "$INSTDIR\tr"
  RMDir /r "$INSTDIR\zh-Hans"
  RMDir /r "$INSTDIR\zh-Hant"
  RMDir /r "$INSTDIR\thirdParty"
  
  ; Remove individual files including license file
  Delete "$INSTDIR\*.dll"
  Delete "$INSTDIR\*.exe"
  Delete "$INSTDIR\*.json"
  Delete "$INSTDIR\*.xml"
  Delete "$INSTDIR\*.wad"
  Delete "$INSTDIR\*.pdb"
  Delete "$INSTDIR\*.exp"
  Delete "$INSTDIR\*.lib"
  Delete "$INSTDIR\*.ico"
  Delete "$INSTDIR\Uninstall.exe"
  Delete "$INSTDIR\thirdParty.zip"
  Delete "$INSTDIR\7z.exe"
  Delete "$INSTDIR\7z.dll"
  Delete "$INSTDIR\VC_redist.x64.exe"
  Delete "$INSTDIR\FChassis-License-Agreement.txt" ; Remove license file
  
  ; Remove installation directory if empty
  RMDir "$INSTDIR"
  
  !insertmacro LogMessage "=== Uninstallation completed ==="
SectionEnd