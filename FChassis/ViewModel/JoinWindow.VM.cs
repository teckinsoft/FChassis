using Microsoft.Win32;
using System.Windows;
using System.Windows.Input;
using System.Windows.Media.Imaging;
using System.Diagnostics;
using System.IO;
using System.Windows.Media;
using System.Runtime.InteropServices;
using System.Threading.Tasks;
using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;

namespace FChassis.VM;

public partial class JoinWindowVM : ObservableObject, IDisposable {
   #region Events
   public event Action<string> EvMirrorAndJoinedFileSaved; // Event to notify MainWindow when a file is saved
   public event Action<string> EvLoadPart;
   public event Action EvRequestCloseWindow;
   #endregion

   #region Properties
   [ObservableProperty]
   private string _part1FileName = "";

   [ObservableProperty]
   private string _part2FileName = "";

   [ObservableProperty]
   private string _joinedFileName = "";

   [ObservableProperty]
   private BitmapImage _thumbnailBitmap;
   #endregion

   #region Fields
   private IGES.IGES _iges;
   private bool _disposed = false;
   private JoinResultVM.JoinResultOption _joinResOpt = JoinResultVM.JoinResultOption.None;
   #endregion

   #region Commands
   [RelayCommand]
   private void LoadPart1 () {
      var fileName = GetFilename (Part1FileName, "Select a Part File",
                                "CAD Files (*.iges;*.igs;*.stp;*.step)|*.iges;*.igs;*.stp;*.step|All Files (*.*)|*.*");
      if (fileName == null) return;

      Part1FileName = fileName;
      Action (() => LoadPart (0)).GetAwaiter ();
   }

   [RelayCommand]
   private void LoadPart2 () {
      var fileName = GetFilename (Part2FileName, "Select a Part File",
                                "CAD Files (*.iges;*.igs;*.stp;*.step)|*.iges;*.igs;*.stp;*.step|All Files (*.*)|*.*");
      if (fileName == null) return;

      Part2FileName = fileName;
      Action (() => LoadPart (1)).GetAwaiter ();
   }

   [RelayCommand]
   private void FlipPart1By180 () => Action (() => Flip180Internal (0)).GetAwaiter ();

   [RelayCommand]
   private void FlipPart2By180 () => Action (() => Flip180Internal (1)).GetAwaiter ();

   [RelayCommand]
   private async Task Join (object parameter) {
      await Action (Join); // Ensure Join() completes before checking the result

      if (parameter is Window currentWindow && (_joinResOpt == JoinResultVM.JoinResultOption.SaveAndOpen ||
         _joinResOpt == JoinResultVM.JoinResultOption.Cancel))
         currentWindow.Close ();
   }
   #endregion

   #region Initialization & Cleanup
   public bool Initialize () {
      Debug.Assert (_iges == null);
      _iges = new IGES.IGES ();
      _iges.Initialize ();
      return true;
   }

   public bool Uninitialize () {
      if (_iges != null) {
         _iges.Uninitialize ();
         _iges.Dispose ();
         _iges = null;
      }
      return true;
   }

   public void Dispose () {
      if (!_disposed) {
         Uninitialize ();
         _disposed = true;
         GC.SuppressFinalize (this);
      }
   }

   ~JoinWindowVM () => Dispose ();
   #endregion

   #region Methods
   int LoadPart (int pNo) {
      if (_iges == null) return -1; // Ensure _iges is initialized

      int errorNo = 1;
      do {
         //int shapeType = 0;

         if (pNo == 0) {
            if ((errorNo = _iges.LoadIGES (Part1FileName, pNo)) != 0)
               break;
            if ((errorNo = _iges.AlignToXYPlane (pNo)) != 0)
               break;
         } else if (pNo == 1) {
            if ((errorNo = _iges.LoadIGES (Part2FileName, pNo)) != 0)
               break;
            if ((errorNo = _iges.AlignToXYPlane (pNo)) != 0)
               break;
         } else break;

         ConvertCadToImage (false, pNo);
      } while (false);

      if (errorNo != 0)
         HandleIGESError (errorNo);

      return errorNo;
   }

   private int Flip180Internal (int pno) {
      if (_iges == null) return -1;
      int errorNo;
      try {
         errorNo = _iges.RotatePartBy180AboutZAxis (pno);
      } catch (Exception ex) {
         MessageBox.Show (ex.Message, "Error", MessageBoxButton.OK, MessageBoxImage.Error);
         return 1;
      }
      if (errorNo == 0)
         ConvertCadToImage (false);
      return errorNo;
   }

   private int UndoJoin () {
      int errorNo = 0;
      if (_iges == null) return -1;
      _iges.UndoJoin ();
      return errorNo;
   }

   private int Join () {
      if (_iges == null) return -1;
      int errorNo;
      try {
         errorNo = _iges.UnionShapes ();
      } catch (Exception ex) {
         MessageBox.Show (ex.Message, "Error", MessageBoxButton.OK, MessageBoxImage.Error);
         return 1;
      }
      if (errorNo == 0)
         ConvertCadToImage (true);

      // Ensure the dialog is opened on the UI thread
      int resVal = Application.Current.Dispatcher.Invoke (() => {
         JoinResult joinResultDialog = new ();
         bool? dialogResult = joinResultDialog.ShowDialog ();

         int res = 1;
         if (dialogResult == true) {
            _joinResOpt = joinResultDialog.joinResVM.Result;

            switch (_joinResOpt) {
               case JoinResultVM.JoinResultOption.SaveAndOpen:
                  res = JoinSave ();
                  if (res == 0)
                     OpenSavedFile ();
                  else return res;
                  break;
               case JoinResultVM.JoinResultOption.Save:
                  res = JoinSave ();
                  break;
               case JoinResultVM.JoinResultOption.Cancel:
               case JoinResultVM.JoinResultOption.None:
                  UndoJoin ();
                  EvRequestCloseWindow?.Invoke ();
                  return 0;
            }
         }
         return res;
      });
      return resVal;
   }

   private void OpenSavedFile () {
      if (!string.IsNullOrEmpty (JoinedFileName)) {
         try {
            EvLoadPart?.Invoke (JoinedFileName);
         } catch (Exception ex) {
            MessageBox.Show ($"Error opening file: {ex.Message}", "Open Error", MessageBoxButton.OK, MessageBoxImage.Error);
         }
      }
   }

   private int JoinSave () {
      if (_iges == null) return -1;
      int errorNo = 0;

      JoinedFileName = SaveFilename (Part1FileName, "Select a Part File",
          "CAD Files (*.iges;*.igs;*.stp;*.step)|*.iges;*.igs;*.stp;*.step|All Files (*.*)|*.*",
          @"W:\FChassis\Sample");

      if (!string.IsNullOrEmpty (JoinedFileName)) {
         errorNo = _iges.SaveIGES (JoinedFileName, 2);

         EvMirrorAndJoinedFileSaved?.Invoke (Path.GetDirectoryName (JoinedFileName));
      }
      return errorNo;
   }
   #endregion

   #region Helper Methods
   private async Task Action (Func<int> func) {
      Mouse.OverrideCursor = Cursors.Wait;
      int errorNo = 0;

      await Task.Run (() => errorNo = func ());

      HandleIGESError (errorNo);
      Mouse.OverrideCursor = null;
   }

   private bool HandleIGESError (int errorNo) {
      if (errorNo == 0 || _iges == null) return false;
      return true;
   }

   void ConvertCadToImage (bool fused, int pno = -1) {
      if (_iges == null) return;
      int width = 800, height = 600;
      byte[] imageData = null!;
      int errorNoFused = 0, errorNoP1 = 0, errorNoP2 = 0;
      if (fused)
         errorNoFused = _iges.GetShape (2, width, height, ref imageData);
      else {
         errorNoP1 = _iges.GetShape (-1, width, height, ref imageData);
      }

      if (errorNoP1 == 0 && errorNoP2 == 0 && errorNoFused != 0) {
         if (HandleIGESError (errorNoFused))
            return;
      }

      UpdateImage (width, height, imageData);
   }

   private void UpdateImage (int width, int height, byte[] imageStream) {
      if (imageStream == null || imageStream.Length == 0) return;

      WriteableBitmap bitmap = new (width, height, 96, 96, PixelFormats.Rgb24, null);
      bitmap.Lock ();
      try {
         Marshal.Copy (imageStream, 0, bitmap.BackBuffer, imageStream.Length);
         bitmap.AddDirtyRect (new Int32Rect (0, 0, width, height));
      } finally {
         bitmap.Unlock ();
      }

      ThumbnailBitmap = ConvertWriteableBitmapToBitmapImage (bitmap);
   }

   private BitmapImage ConvertWriteableBitmapToBitmapImage (WriteableBitmap wbm) {
      BitmapImage bmImage = new ();
      using (MemoryStream stream = new ()) {
         PngBitmapEncoder encoder = new ();
         encoder.Frames.Add (BitmapFrame.Create (wbm));
         encoder.Save (stream);
         bmImage.BeginInit ();
         bmImage.CacheOption = BitmapCacheOption.OnLoad;
         bmImage.StreamSource = stream;
         bmImage.EndInit ();
         bmImage.Freeze ();
      }
      return bmImage;
   }

   private string GetFilename (string fileName, string title, string filter = "All files (*.*)|*.*",
                              bool multiselect = false, string initialFolder = null) {
      OpenFileDialog openDlg = new () {
         Title = title,
         Filter = filter,
         Multiselect = multiselect,
         InitialDirectory = initialFolder ?? @"W:\FChassis\Sample",
         FileName = fileName
      };
      return openDlg.ShowDialog () == true ? openDlg.FileName : null;
   }

   private string SaveFilename (string fileName, string title, string filter = "All files (*.*)|*.*",
                               string initialFolder = null) {
      SaveFileDialog saveDlg = new () {
         Title = title,
         Filter = filter,
         InitialDirectory = initialFolder ?? @"W:\FChassis\Sample",
         FileName = fileName
      };
      return saveDlg.ShowDialog () == true ? saveDlg.FileName : null;
   }
   #endregion
}